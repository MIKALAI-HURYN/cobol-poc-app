       IDENTIFICATION DIVISION.
       PROGRAM-ID. ACCTXFRM.
       AUTHOR. BANKING-SYSTEM.
      *****************************************************************
      * PROGRAM NAME: ACCTXFRM (MySQL Version for WSL)               *
      * DESCRIPTION:  DATA TRANSFORMATION FROM CUSTOMERACCOUNTS       *
      *               TO ACCOUNTTRANSACTIONS TABLE                    *
      * DATABASE:     MySQL (AWS Aurora compatible)                   *
      *****************************************************************

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. LINUX.
       OBJECT-COMPUTER. LINUX.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT INPUT-FILE ASSIGN TO "accounts.dat"
               ORGANIZATION IS LINE SEQUENTIAL
               FILE STATUS IS WS-INPUT-STATUS.

           SELECT OUTPUT-FILE ASSIGN TO "transactions.sql"
               ORGANIZATION IS LINE SEQUENTIAL
               FILE STATUS IS WS-OUTPUT-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD  INPUT-FILE.
       01  INPUT-RECORD            PIC X(500).

       FD  OUTPUT-FILE.
       01  OUTPUT-RECORD           PIC X(800).

       WORKING-STORAGE SECTION.

      * FILE STATUS CODES
       01  WS-INPUT-STATUS         PIC XX.
           88 INPUT-EOF            VALUE "10".
           88 INPUT-OK             VALUE "00".
       01  WS-OUTPUT-STATUS        PIC XX.

      * SOURCE RECORD VARIABLES (FROM CUSTOMERACCOUNTS)
       01  WS-SOURCE-RECORD.
           05 WS-ACCT-ID           PIC 9(10).
           05 WS-CUST-ID           PIC 9(10).
           05 WS-CUST-NAME         PIC X(100).
           05 WS-ACCT-NUM          PIC X(20).
           05 WS-ACCT-TYPE         PIC X(20).
           05 WS-BALANCE           PIC S9(13)V99.
           05 WS-BRANCH            PIC X(10).
           05 WS-KYC               PIC X(20).
           05 WS-RISK              PIC 9(3).
           05 WS-ACCT-STATUS       PIC X(20).
           05 WS-CREATED           PIC X(26).
           05 WS-UPDATED           PIC X(26).

      * TARGET RECORD VARIABLES (FOR ACCOUNTTRANSACTIONS)
       01  WS-TARGET-RECORD.
           05 TGT-ACCT-ID          PIC 9(10).
           05 TGT-CUST-ID          PIC 9(10).
           05 TGT-ACCT-NUM         PIC X(20).
           05 TGT-DESC             PIC X(200).
           05 TGT-SUBTYPE          PIC X(30).
           05 TGT-AMOUNT           PIC S9(13)V99.
           05 TGT-RUNBAL           PIC S9(13)V99.
           05 TGT-BRANCH           PIC X(10).
           05 TGT-REFNUM           PIC X(50).
           05 TGT-PROC-STATUS      PIC X(20) VALUE "PROCESSED".

      * FORMATTED FIELDS FOR SQL
       01  WS-SQL-FIELDS.
           05 WS-AMOUNT-EDIT       PIC -9999999999999.99.
           05 WS-AMOUNT-STR        PIC X(20).
           05 WS-RUNBAL-EDIT       PIC -9999999999999.99.
           05 WS-RUNBAL-STR        PIC X(20).

      * WORK VARIABLES
       01  WS-COUNTERS.
           05 WS-RECORDS-READ      PIC 9(9) VALUE 0.
           05 WS-RECORDS-PROCESSED PIC 9(9) VALUE 0.
           05 WS-RECORDS-SKIPPED   PIC 9(9) VALUE 0.

       01  WS-SQL-STATEMENT        PIC X(800).
       01  WS-DISPLAY-LINE         PIC X(80).

       PROCEDURE DIVISION.

       0000-MAIN-PROCESS.
           PERFORM 1000-INITIALIZATION
           PERFORM 2000-PROCESS-RECORDS
           PERFORM 3000-FINALIZATION
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY "================================================"
           DISPLAY "ACCOUNT TRANSFORMATION PROGRAM STARTED"
           DISPLAY "MySQL/Aurora Version for WSL"
           DISPLAY "================================================"

           OPEN INPUT INPUT-FILE
           IF NOT INPUT-OK
               DISPLAY "ERROR OPENING INPUT FILE: " WS-INPUT-STATUS
               MOVE 8 TO RETURN-CODE
               STOP RUN
           END-IF

           OPEN OUTPUT OUTPUT-FILE
           IF WS-OUTPUT-STATUS NOT = "00"
               DISPLAY "ERROR OPENING OUTPUT FILE: " WS-OUTPUT-STATUS
               CLOSE INPUT-FILE
               MOVE 8 TO RETURN-CODE
               STOP RUN
           END-IF

           DISPLAY "Files opened successfully"

      * Write SQL file header
           MOVE "-- Generated INSERT statements for AccountTransacti
      -    "ons" TO OUTPUT-RECORD
           WRITE OUTPUT-RECORD
           MOVE "-- Generated by ACCTXFRM COBOL Program"
               TO OUTPUT-RECORD
           WRITE OUTPUT-RECORD
           MOVE " " TO OUTPUT-RECORD
           WRITE OUTPUT-RECORD.

       2000-PROCESS-RECORDS.
           PERFORM 2100-READ-RECORD
           PERFORM 2200-PROCESS-LOOP
               UNTIL INPUT-EOF.

       2100-READ-RECORD.
           READ INPUT-FILE INTO INPUT-RECORD
               AT END SET INPUT-EOF TO TRUE
               NOT AT END
                   ADD 1 TO WS-RECORDS-READ
                   PERFORM 2150-PARSE-INPUT
           END-READ.

       2150-PARSE-INPUT.
      * Parse pipe-delimited input: ID|AcctID|Name|AcctNum|Type|Bal|Branch|KYC|Risk|Status|Created|Updated
           UNSTRING INPUT-RECORD DELIMITED BY "|"
               INTO WS-ACCT-ID, WS-CUST-ID, WS-CUST-NAME,
                    WS-ACCT-NUM, WS-ACCT-TYPE, WS-BALANCE,
                    WS-BRANCH, WS-KYC, WS-RISK,
                    WS-ACCT-STATUS, WS-CREATED, WS-UPDATED
           END-UNSTRING.

       2200-PROCESS-LOOP.
           IF NOT INPUT-EOF
               PERFORM 2300-TRANSFORM-DATA
               PERFORM 2400-GENERATE-SQL
               PERFORM 2100-READ-RECORD
           END-IF.

       2300-TRANSFORM-DATA.
      * Only process Active accounts
           IF WS-ACCT-STATUS NOT = "Active"
               ADD 1 TO WS-RECORDS-SKIPPED
               EXIT PARAGRAPH
           END-IF

      * MOVE BASIC FIELDS
           MOVE WS-ACCT-ID TO TGT-ACCT-ID
           MOVE WS-CUST-ID TO TGT-CUST-ID
           MOVE WS-ACCT-NUM TO TGT-ACCT-NUM

      * CREATE DESCRIPTION WITH CUSTOMER NAME
           INITIALIZE TGT-DESC
           STRING "Customer: " DELIMITED BY SIZE
                  WS-CUST-NAME DELIMITED BY "  "
                  " - Account Inquiry" DELIMITED BY SIZE
                  INTO TGT-DESC
           END-STRING

      * DETERMINE SUBTYPE BASED ON ACCOUNT TYPE
           EVALUATE WS-ACCT-TYPE
               WHEN "Checking"
                   MOVE "CHK-Inquiry" TO TGT-SUBTYPE
               WHEN "Savings"
                   MOVE "SAV-Inquiry" TO TGT-SUBTYPE
               WHEN "Investment"
                   MOVE "INV-Inquiry" TO TGT-SUBTYPE
               WHEN "Credit"
                   MOVE "CRD-Inquiry" TO TGT-SUBTYPE
               WHEN OTHER
                   MOVE "GEN-Inquiry" TO TGT-SUBTYPE
           END-EVALUATE

      * MOVE BALANCE TO AMOUNT AND RUNNING BALANCE
           MOVE WS-BALANCE TO TGT-AMOUNT
           MOVE WS-BALANCE TO TGT-RUNBAL

      * MOVE BRANCH CODE
           MOVE WS-BRANCH TO TGT-BRANCH

      * CREATE REFERENCE NUMBER WITH RISK SCORE
           INITIALIZE TGT-REFNUM
           STRING "RSK-" DELIMITED BY SIZE
                  WS-RISK DELIMITED BY SIZE
                  "-" DELIMITED BY SIZE
                  WS-ACCT-NUM DELIMITED BY " "
                  INTO TGT-REFNUM
           END-STRING

           ADD 1 TO WS-RECORDS-PROCESSED

      * DISPLAY PROGRESS EVERY 100 RECORDS
           IF FUNCTION MOD(WS-RECORDS-PROCESSED, 100) = 0
               STRING "Processed " DELIMITED BY SIZE
                      WS-RECORDS-PROCESSED DELIMITED BY SIZE
                      " records" DELIMITED BY SIZE
                      INTO WS-DISPLAY-LINE
               DISPLAY WS-DISPLAY-LINE
           END-IF.

       2400-GENERATE-SQL.
      * Initialize SQL statement buffer
           INITIALIZE WS-SQL-STATEMENT

      * Convert numeric fields to strings
           MOVE TGT-AMOUNT TO WS-AMOUNT-EDIT
           MOVE WS-AMOUNT-EDIT TO WS-AMOUNT-STR
           MOVE TGT-RUNBAL TO WS-RUNBAL-EDIT
           MOVE WS-RUNBAL-EDIT TO WS-RUNBAL-STR

      * Build INSERT statement (matching actual MySQL table structure)
           STRING
               "INSERT INTO AccountTransactions "
               "(AccountID, CustomerID, AccountNumber, "
               "Description, TransactionSubType, Amount, "
               "RunningBalance, BranchCode, ReferenceNumber, "
               "Channel) VALUES ("
               DELIMITED BY SIZE
               TGT-ACCT-ID DELIMITED BY SIZE
               ", " DELIMITED BY SIZE
               TGT-CUST-ID DELIMITED BY SIZE
               ", '" DELIMITED BY SIZE
               FUNCTION TRIM(TGT-ACCT-NUM) DELIMITED BY SIZE
               "', '" DELIMITED BY SIZE
               FUNCTION TRIM(TGT-DESC) DELIMITED BY SIZE
               "', '" DELIMITED BY SIZE
               FUNCTION TRIM(TGT-SUBTYPE) DELIMITED BY SIZE
               "', " DELIMITED BY SIZE
               FUNCTION TRIM(WS-AMOUNT-STR) DELIMITED BY SIZE
               ", " DELIMITED BY SIZE
               FUNCTION TRIM(WS-RUNBAL-STR) DELIMITED BY SIZE
               ", '" DELIMITED BY SIZE
               FUNCTION TRIM(TGT-BRANCH) DELIMITED BY SIZE
               "', '" DELIMITED BY SIZE
               FUNCTION TRIM(TGT-REFNUM) DELIMITED BY SIZE
               "', 'COBOL-Batch');" DELIMITED BY SIZE
               INTO WS-SQL-STATEMENT
           END-STRING

      * Write to output file
           MOVE WS-SQL-STATEMENT TO OUTPUT-RECORD
           WRITE OUTPUT-RECORD.

       3000-FINALIZATION.
           CLOSE INPUT-FILE
           CLOSE OUTPUT-FILE

           DISPLAY "================================================"
           DISPLAY "TRANSFORMATION COMPLETED"
           DISPLAY "Records read:     " WS-RECORDS-READ
           DISPLAY "Records processed:" WS-RECORDS-PROCESSED
           DISPLAY "Records skipped:  " WS-RECORDS-SKIPPED
           DISPLAY "================================================"
           DISPLAY "SQL file created: transactions.sql"
           DISPLAY "Run: mysql -u user -p banking < transactions.sql"
           DISPLAY "================================================".
